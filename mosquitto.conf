# Mosquitto MQTT Broker Configuration

# NETWORK LISTENERS

# Listen on all network interfaces (allows external connections)
listener 1883 0.0.0.0


# AUTHENTICATION & AUTHORIZATION

# Allow anonymous connections (DEVELOPMENT ONLY)
# For production, set to false and configure authentication
allow_anonymous true

# Production authentication (uncomment and configure for production):
# allow_anonymous false
# password_file /etc/mosquitto/passwd
# acl_file /etc/mosquitto/acl

# PERSISTENCE

# Enable message persistence
persistence true
persistence_location /var/lib/mosquitto/

# Save in-flight messages
autosave_interval 60
autosave_on_changes false

# Retain database
persistence_file mosquitto.db

# LOGGING

# Log to stdout (captured by Docker)
log_dest stdout

# Log types
log_type error
log_type warning
log_type notice
log_type information

# Optional: Enable connection logging for debugging
# log_type subscribe
# log_type unsubscribe

# Timestamp format
log_timestamp true
log_timestamp_format %Y-%m-%d %H:%M:%S

# CONNECTION LIMITS & TIMEOUTS

# Maximum number of concurrent connections (-1 = unlimited)
max_connections -1

# Maximum queued messages per client
max_queued_messages 1000

# Maximum QoS 1 and 2 messages in flight
max_inflight_messages 20

# MESSAGE SIZE & RATE LIMITS

# Maximum message size (1MB for sensor data with images)
message_size_limit 1048576

# Maximum publish rate per client (0 = unlimited)
# Uncomment for rate limiting:
# max_publish_rate 100

# KEEPALIVE SETTINGS

# Maximum keepalive time (0 = disabled, client can set any value)
max_keepalive 65535

# Default: 60 seconds (matches Python client setting)

# RETAINED MESSAGES

# Allow retained messages (useful for heartbeat)
retain_available true

# Maximum number of retained messages (0 = unlimited)
max_retained_messages 0

# QUALITY OF SERVICE (QoS)

# Maximum QoS level (0, 1, or 2)
max_qos 2

# Upgrade QoS if subscription requests higher than publish
upgrade_outgoing_qos false

# PROTOCOL SETTINGS

# MQTT protocol version
# 3 = MQTT v3.1, 4 = MQTT v3.1.1, 5 = MQTT v5
protocol_version 31


# SECURITY (TLS/SSL) - For Production

# Uncomment for TLS encryption (production):
# listener 8883 0.0.0.0
# cafile /etc/mosquitto/ca_certificates/ca.crt
# certfile /etc/mosquitto/certs/server.crt
# keyfile /etc/mosquitto/certs/server.key
# require_certificate false
# use_identity_as_username false

# PERFORMANCE TUNING

# Disable Nagle algorithm for lower latency
set_tcp_nodelay true

# HEALTH CHECK TOPIC (For Docker/Monitoring)

# The health/heartbeat topic can be used for monitoring
# Retained messages ensure last heartbeat is always available

# NOTES

# This configuration is optimized for:
# - Docker deployment
# - Local network access (192.168.x.x)
# - Health monitoring with QoS 0, 1, and 2
# - Retained heartbeat messages
# - Anonymous access (development)
#
# For production:
# 1. Set allow_anonymous false
# 2. Enable TLS (listener 8883)
# 3. Configure authentication (password_file)
# 4. Set up ACL for topic restrictions
# 5. Enable rate limiting if needed