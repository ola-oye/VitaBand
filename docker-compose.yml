version: '3.8'

services:
  vitaband:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vitaband
    hostname: vitaband
    
    # Restart policy
    restart: unless-stopped
    
    # Network mode for mDNS (host network required)
    network_mode: host
    
    # Privileged mode for hardware access (I2C sensors)
    privileged: true
    
    # Device access for I2C
    devices:
      - /dev/i2c-1:/dev/i2c-1
    
    # Environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - MQTT_BROKER=localhost
      - MQTT_PORT=1883
      - MQTT_USE_AUTH=false
      - MQTT_USE_TLS=false
      - LOG_LEVEL=INFO
      # For Enable authentication
      # - MQTT_USE_AUTH=true
      # - MQTT_USERNAME=raspberry_pi
      # - MQTT_PASSWORD=your_secure_password
    
    # Volumes for persistent data
    volumes:
      # Data persistence
      - ./data:/app/data
      - ./logs:/app/logs
      - ./model:/app/model
      
      # CSV output
      - ./output:/app/output
      
      # Mosquitto data
      - mosquitto-data:/var/lib/mosquitto
      - mosquitto-log:/var/log/mosquitto

      # Configuration files
      - ../config:/app/config
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    
    # Health check
    healthcheck:
      test: ["CMD", "sh", "-c", "mosquitto_sub -h localhost -t 'health/heartbeat' -C 1 -W 5 && pgrep -x avahi-daemon"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Labels for organization
    labels:
      - "app=VitaBand"
      - "component=main-system"
      - "version=1.0"

# Named volumes
volumes:
  mosquitto-data:
    driver: local
  mosquitto-log:
    driver: local